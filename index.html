<!DOCTYPE html>
<html lang="pt-br">
<head>
	<meta charset="utf-8">
	<title>PUB/SUB MQTT</title>
</head>
<body style="font-family: sans-serif;">
	<div>
		<input type="button" id="connect" value="Conectar">
		<p>
			Status:
			<span id="status">Desconectado!!!</span>
			Client ID:
			<span id="client_id"></span>
		</p>
		<p>
			<input type="text" id="topic_pub">
			<input type="text" id="message">
			<input type="button" id="publicar" value="Publicar">
		</p>
		<p>
			<input type="text" id="topic_sub" value="#">
			<input type="button" id="subscrever" value="Subscrever">
		</p>
		<p>
			<span>Monitor: <input type="button" id="delete" value="x" title="limpar"></span>
		</p>
		<p>Tópico:<span id="topico_assinado"></span></p>
		<p><span id="monitor"></span></p>
	</div>
	<script type="text/javascript" src="assets/config.js"></script>
	<script type="text/javascript" src="assets/jquery-3.2.1.min.js"></script>
	<script type="text/javascript" src="assets/mqttws31.js"></script>
	<script type="text/javascript">
		var topico = "#";
		$("#topic_pub,#topic_sub,#message,#publicar,#subscrever").attr('disabled', true);
		function MQTTConnect(){
			if (typeof path == "undefined") {
				path = '/mqtt';
			}
			client_id = Math.floor((Math.random() * 100) + 1).toString();
			$("#client_id").html(client_id);
			client = new Paho.MQTT.Client(host, port, path, 'client_id');
			client.onConnectionLost = onConnectionLost;
			client.onMessageArrived = onMessageArrived;

			client.connect({onSuccess:onConnect});

			function onConnect() {
				$("#topic_pub,#topic_sub,#message,#publicar,#subscrever").attr('disabled', false);
				$('#status').html('Conectado em ' + host + ':' + port + path);
				console.log("onConnect");
				client.subscribe(topico);
				$('#topico_assinado').html(topico);
			}

			function onConnectionLost(responseObject) {
				if (responseObject.errorCode !== 0) {
					$("#topic_pub,#topic_sub,#message,#publicar,#subscrever").attr('disabled', true);
					$('#status').html("Conexão perdida:"+responseObject.errorMessage);
					console.log("Conexão perdida:"+responseObject.errorMessage);
				}
			}
			//chamado quando recebe uma menssagem
			function onMessageArrived(message) {
				$("#monitor").append("> "+message.destinationName +":"+ message.payloadString+"<br>");
				console.log("mensagem que chegou:"+message.payloadString);
			}
		}
		function publicar(destino,mensagem){
			message = new Paho.MQTT.Message(mensagem);
			message.destinationName = destino;
			client.send(message);
		}
		$("#publicar").click(function(){
			if($('#topic_pub').val() != '' || $('#message').val() != ''){
				publicar($('#topic_pub').val(),$('#message').val());	
			}else{
				alert("Você deve preencher os campos de tópico e menssagem antes de publicar!!!");
				$("#topic_pub").focus();
			}
		});
		$("#subscrever,#connect").click(function(){
			topico = $("#topic_sub").val();
			MQTTConnect();
		});
		$("#delete").click(function(){
			$("#monitor").html(" ");
		});
	</script>
</body>
</html>